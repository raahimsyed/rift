<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W1SEMRGLRR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-W1SEMRGLRR');
    </script><title>Rift Chat</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="./global/css/global.css">
    <style>
        .chat-shell {
            width: min(94vw, 1080px);
            height: min(72vh, 760px);
            margin: 0 auto;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 14px;
        }

        .chat-panel {
            border: 1px solid rgba(255, 255, 255, 0.14);
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(10px);
            min-height: 0;
        }

        .rooms-panel {
            display: grid;
            grid-template-rows: auto auto 1fr;
            overflow: hidden;
        }

        .panel-title {
            padding: 14px 16px 8px;
            color: #fff;
            font-size: 14px;
            text-transform: lowercase;
            letter-spacing: 0.08em;
        }

        .panel-sub {
            color: rgba(255, 255, 255, 0.62);
            font-size: 11px;
            margin-top: 4px;
            line-height: 1.5;
        }

        .create-room {
            padding: 10px 16px 14px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: grid;
            gap: 8px;
        }

        .chat-input,
        .chat-select {
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.18);
            background: rgba(0, 0, 0, 0.32);
            color: #fff;
            border-radius: 10px;
            padding: 9px 10px;
            font-family: "Run", Arial, sans-serif;
            font-size: 12px;
            outline: none;
        }

        .chat-select option {
            background: #151515;
            color: #fff;
        }

        .chat-input:focus,
        .chat-select:focus {
            border-color: rgba(255, 255, 255, 0.36);
            background: rgba(255, 255, 255, 0.08);
        }

        .chat-btn {
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.09);
            color: white;
            border-radius: 10px;
            padding: 10px 12px;
            cursor: pointer;
            font-family: "Run", Arial, sans-serif;
            font-size: 12px;
            text-transform: lowercase;
        }

        .chat-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .room-list {
            overflow: auto;
            padding: 12px;
            display: grid;
            gap: 8px;
            align-content: start;
        }

        .room-item {
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.82);
            padding: 9px 10px;
            cursor: pointer;
            text-align: left;
            display: grid;
            gap: 4px;
            font-family: "Run", Arial, sans-serif;
        }

        .room-item.active {
            border-color: rgba(255, 255, 255, 0.38);
            background: rgba(255, 255, 255, 0.14);
            color: #fff;
        }

        .room-name {
            font-size: 12px;
            word-break: break-word;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .room-meta {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.56);
        }

        .chat-main {
            display: grid;
            grid-template-rows: auto 1fr auto;
            min-height: 0;
        }

        .chat-head {
            padding: 14px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        .chat-head-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .chat-head-title {
            color: #fff;
            font-size: 14px;
            text-transform: lowercase;
            letter-spacing: 0.06em;
            word-break: break-word;
        }

        .chat-head-meta {
            color: rgba(255, 255, 255, 0.58);
            font-size: 11px;
        }

        .message-list {
            min-height: 0;
            overflow: auto;
            padding: 12px 14px;
            display: grid;
            gap: 8px;
            align-content: start;
        }
        .room-gate {
            min-height: 100%;
            display: grid;
            place-items: center;
            padding: 18px;
        }
        .room-gate-card {
            width: min(420px, 100%);
            border: 1px solid rgba(255, 255, 255, 0.14);
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.05);
            padding: 14px;
            display: grid;
            gap: 10px;
        }
        .room-gate-title {
            color: #fff;
            font-size: 13px;
            text-transform: lowercase;
            letter-spacing: 0.06em;
        }
        .room-gate-note {
            color: rgba(255, 255, 255, 0.64);
            font-size: 11px;
            line-height: 1.45;
        }
        .room-gate-error {
            color: #ff9b9b;
            font-size: 11px;
            min-height: 14px;
        }

        .message {
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.04);
            border-radius: 12px;
            padding: 8px 10px;
            word-break: break-word;
        }

        .message-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 4px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 10px;
        }

        .message-user {
            color: #fff;
            font-size: 11px;
        }

        .message-text {
            color: rgba(255, 255, 255, 0.88);
            font-size: 12px;
            line-height: 1.45;
            white-space: pre-wrap;
        }

        .chat-compose {
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            padding: 10px 12px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
        }

        .chat-status {
            color: rgba(255, 255, 255, 0.64);
            font-size: 11px;
            margin-top: 2px;
            min-height: 16px;
            text-transform: lowercase;
        }

        @media (max-width: 900px) {
            .chat-shell {
                grid-template-columns: 1fr;
                height: min(76vh, 900px);
            }

            .rooms-panel {
                max-height: 320px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>rift chat</h1>
            <p class="page-subtitle">public + private rooms</p>
        </header>

        <section class="chat-shell">
            <aside class="chat-panel rooms-panel">
                <div class="panel-title">
                    chatrooms
                    <div class="panel-sub">create public/private rooms, then join from this list.</div>
                </div>
                <form id="createRoomForm" class="create-room">
                    <input id="roomNameInput" class="chat-input" maxlength="40" placeholder="unique room name" required>
                    <select id="roomTypeInput" class="chat-select" aria-label="room type">
                        <option value="public">public</option>
                        <option value="private">private</option>
                    </select>
                    <input id="roomPasswordInput" class="chat-input" type="password" maxlength="64" placeholder="password (private only)" style="display:none;">
                    <button type="submit" class="chat-btn">create room</button>
                    <div id="roomCreateStatus" class="chat-status"></div>
                </form>
                <div id="roomList" class="room-list"></div>
            </aside>

            <section class="chat-panel chat-main">
                <div class="chat-head">
                    <div>
                        <div id="activeRoomName" class="chat-head-title"># lobby</div>
                        <div id="activeRoomMeta" class="chat-head-meta">select a room to chat</div>
                    </div>
                    <div class="chat-head-actions">
                        <button id="deleteRoomBtn" type="button" class="chat-btn" style="display:none;">delete room</button>
                    </div>
                </div>
                <div id="messageList" class="message-list"></div>
                <form id="messageForm" class="chat-compose">
                    <input id="messageInput" class="chat-input" maxlength="400" placeholder="type message..." autocomplete="off">
                    <button type="submit" class="chat-btn">send</button>
                </form>
            </section>
        </section>
    </div>

            <nav class="bottom-nav">
        <button class="nav-button" onclick="location.href='/'">
            <span class="material-icons">home</span>
        </button>
        <button class="nav-button" onclick="location.href='/games'">
            <span class="material-icons">sports_esports</span>
        </button>
        <button class="nav-button" onclick="location.href='/apps'">
            <span class="material-icons">apps</span>
        </button>
        <button class="nav-button" onclick="location.href='/music'">
            <span class="material-icons">library_music</span>
        </button>
        <button class="nav-button active" onclick="location.href='/chat'">
            <span class="material-icons">forum</span>
        </button>
        <button class="nav-button" onclick="location.href='/browser'">
            <span class="material-icons">language</span>
        </button>
        <button class="nav-button" onclick="location.href='/account'">
            <span class="material-icons">person</span>
        </button>
        <button class="nav-button" onclick="location.href='/settings'">
            <span class="material-icons">settings</span>
        </button>
        <button class="nav-button" onclick="location.href='/credits'">
            <span class="material-icons">handshake</span>
        </button>
        <button class="nav-button" onclick="location.href='/social-media-&-partners'">
            <span class="material-icons">connect_without_contact</span>
        </button>
    </nav>

    <script src="./global/js/global.js"></script>
    <script src="/components/cloaker.js"></script>
    <script src="/components/overlay.js"></script>
    <script src="/components/components.js"></script>
    <script src="/components/404.js"></script>
    <script>
        document.body.classList.add('nav-pos-' + (localStorage.getItem('rift__nav-position') || 'bottom'));

        const roomListEl = document.getElementById('roomList');
        const roomCreateStatusEl = document.getElementById('roomCreateStatus');
        const roomNameInput = document.getElementById('roomNameInput');
        const roomTypeInput = document.getElementById('roomTypeInput');
        const roomPasswordInput = document.getElementById('roomPasswordInput');
        const activeRoomNameEl = document.getElementById('activeRoomName');
        const activeRoomMetaEl = document.getElementById('activeRoomMeta');
        const messageListEl = document.getElementById('messageList');
        const messageInput = document.getElementById('messageInput');
        const deleteRoomBtn = document.getElementById('deleteRoomBtn');

        const state = {
            rooms: [],
            activeRoomId: 'lobby',
            sinceByRoom: {},
            knownRoomPasswords: {},
            pollTimer: null,
            me: null,
        };

        function setCreateStatus(text) {
            roomCreateStatusEl.textContent = text || '';
        }

        function escapeHtml(text) {
            return String(text || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function formatStamp(ms) {
            if (!ms) return '';
            try {
                return new Date(ms).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } catch {
                return '';
            }
        }

        async function apiRequest(url, options = {}) {
            const res = await fetch(url, {
                credentials: 'include',
                headers: { 'Content-Type': 'application/json', ...(options.headers || {}) },
                ...options,
            });
            let payload = null;
            try {
                payload = await res.json();
            } catch {
                payload = null;
            }
            if (!res.ok) {
                const error = new Error(payload && payload.error ? payload.error : `request failed (${res.status})`);
                error.status = res.status;
                throw error;
            }
            return payload;
        }

        async function requireAuth() {
            try {
                const me = await window.RiftAuth.me();
                if (!me.authenticated) {
                    location.href = '/account';
                    return false;
                }
                state.me = me.user || null;
                return true;
            } catch {
                location.href = '/account';
                return false;
            }
        }

        function canDeleteRoom(room) {
            if (!room || room.id === 'lobby' || room.id === 'links' || !state.me) return false;
            const meUsername = String(state.me.username || '').toLowerCase();
            if (meUsername === 'rift') return true;
            return room.ownerUsername === state.me.username;
        }

        function isRiftAdminClient() {
            return String(state.me?.username || '').toLowerCase() === 'rift';
        }

        function syncDeleteButton(room) {
            if (canDeleteRoom(room)) {
                deleteRoomBtn.style.display = '';
                return;
            }
            deleteRoomBtn.style.display = 'none';
        }

        function getRoomPassword(room) {
            if (!room || !room.isPrivate) return '';
            return state.knownRoomPasswords[room.id] || '';
        }

        function clearRoomPassword(roomId) {
            delete state.knownRoomPasswords[roomId];
        }

        function renderRooms() {
            if (!state.rooms.length) {
                roomListEl.innerHTML = '<div class="chat-status">no rooms yet</div>';
                return;
            }
            roomListEl.innerHTML = state.rooms.map((room) => {
                const isActive = room.id === state.activeRoomId;
                const roomIcon = room.isPrivate ? 'lock' : 'public';
                const stamp = formatStamp(room.lastMessageAt || room.createdAt);
                return `
                    <button type="button" class="room-item ${isActive ? 'active' : ''}" data-room-id="${escapeHtml(room.id)}">
                        <div class="room-name"><span class="material-icons">${roomIcon}</span># ${escapeHtml(room.name)}</div>
                        <div class="room-meta">owner: ${escapeHtml(room.ownerUsername || 'unknown')} ${stamp ? `| last: ${escapeHtml(stamp)}` : ''}</div>
                    </button>
                `;
            }).join('');

            roomListEl.querySelectorAll('.room-item').forEach((button) => {
                button.addEventListener('click', () => {
                    const roomId = button.getAttribute('data-room-id');
                    selectRoom(roomId);
                });
            });
        }

        function setActiveRoomHeader(room) {
            if (!room) {
                activeRoomNameEl.textContent = '# lobby';
                activeRoomMetaEl.textContent = 'select a room to chat';
                syncDeleteButton(null);
                return;
            }
            activeRoomNameEl.textContent = `# ${room.name}`;
            activeRoomMetaEl.textContent = room.isPrivate ? 'private room' : 'public room';
            syncDeleteButton(room);
        }

        function appendMessages(messages) {
            if (!Array.isArray(messages) || !messages.length) return;
            const html = messages.map((msg) => `
                <article class="message">
                    <div class="message-meta">
                        <span class="message-user">${escapeHtml(msg.username || 'user')}</span>
                        <span>${escapeHtml(formatStamp(msg.createdAt))}</span>
                    </div>
                    <div class="message-text">${escapeHtml(msg.text || '')}</div>
                </article>
            `).join('');
            messageListEl.insertAdjacentHTML('beforeend', html);
            messageListEl.scrollTop = messageListEl.scrollHeight;
        }

        function showRoomGate(room, errorText) {
            if (!room || !room.isPrivate) return;
            messageListEl.innerHTML = `
                <div class="room-gate">
                    <form id="roomGateForm" class="room-gate-card">
                        <div class="room-gate-title">join private room: #${escapeHtml(room.name)}</div>
                        <div class="room-gate-note">enter room password to load chat messages.</div>
                        <input id="roomGatePassword" class="chat-input" type="password" maxlength="64" placeholder="room password" required>
                        <div class="room-gate-error">${escapeHtml(errorText || '')}</div>
                        <button class="chat-btn" type="submit">join room</button>
                    </form>
                </div>
            `;
            const form = document.getElementById('roomGateForm');
            const input = document.getElementById('roomGatePassword');
            if (input) input.focus();
            if (form) {
                form.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const value = String(input?.value || '').trim();
                    if (!value) return;
                    state.knownRoomPasswords[room.id] = value;
                    await fetchMessages({ reset: true });
                });
            }
        }

        async function fetchRooms() {
            const payload = await apiRequest('/api/chat/rooms');
            state.rooms = Array.isArray(payload.rooms) ? payload.rooms : [];
            if (!state.rooms.some((room) => room.id === state.activeRoomId)) {
                state.activeRoomId = state.rooms.length ? state.rooms[0].id : 'lobby';
            }
            renderRooms();
            setActiveRoomHeader(state.rooms.find((room) => room.id === state.activeRoomId));
        }

        async function fetchMessages({ reset = false } = {}) {
            const room = state.rooms.find((entry) => entry.id === state.activeRoomId);
            if (!room) return;
            if (reset) {
                state.sinceByRoom[room.id] = 0;
                messageListEl.innerHTML = '';
            }

            const since = state.sinceByRoom[room.id] || 0;
            const params = new URLSearchParams({ room: room.id });
            if (since > 0) params.set('since', String(since));
            const password = getRoomPassword(room);
            if (room.isPrivate) {
                if (!password && !isRiftAdminClient()) {
                    showRoomGate(room, '');
                    return;
                }
                if (password) params.set('password', password);
            }

            try {
                const payload = await apiRequest(`/api/chat/messages?${params.toString()}`);
                const messages = Array.isArray(payload.messages) ? payload.messages : [];
                appendMessages(messages);
                if (messages.length) {
                    const last = messages[messages.length - 1];
                    state.sinceByRoom[room.id] = Number(last.createdAt) || Date.now();
                }
            } catch (error) {
                if (error.status === 403 && room.isPrivate) {
                    clearRoomPassword(room.id);
                    activeRoomMetaEl.textContent = 'wrong password, try again';
                    showRoomGate(room, 'wrong password');
                    return;
                }
                activeRoomMetaEl.textContent = error.message || 'failed to load messages';
            }
        }

        async function selectRoom(roomId) {
            if (!roomId) return;
            state.activeRoomId = roomId;
            renderRooms();
            const room = state.rooms.find((entry) => entry.id === roomId);
            setActiveRoomHeader(room);
            await fetchMessages({ reset: true });
        }

        async function createRoom(event) {
            event.preventDefault();
            const name = roomNameInput.value.trim();
            const isPrivate = roomTypeInput.value === 'private';
            const password = roomPasswordInput.value;

            if (!name) {
                setCreateStatus('room name required');
                return;
            }
            if (isPrivate && password.length < 4) {
                setCreateStatus('private room password must be 4+ chars');
                return;
            }

            try {
                const payload = await apiRequest('/api/chat/rooms', {
                    method: 'POST',
                    body: JSON.stringify({
                        name,
                        isPrivate,
                        password: isPrivate ? password : '',
                    }),
                });
                const room = payload.room;
                if (room && room.isPrivate && password) {
                    state.knownRoomPasswords[room.id] = password;
                }
                roomNameInput.value = '';
                roomPasswordInput.value = '';
                setCreateStatus('room created');
                await fetchRooms();
                if (room && room.id) {
                    await selectRoom(room.id);
                }
            } catch (error) {
                setCreateStatus(error.message || 'room create failed');
            }
        }

        async function sendMessage(event) {
            event.preventDefault();
            const text = messageInput.value.trim();
            if (!text) return;
            const room = state.rooms.find((entry) => entry.id === state.activeRoomId);
            if (!room) return;
            const password = room.isPrivate ? getRoomPassword(room) : '';
            if (room.isPrivate && !password && !isRiftAdminClient()) {
                showRoomGate(room, '');
                return;
            }

            try {
                await apiRequest('/api/chat/messages', {
                    method: 'POST',
                    body: JSON.stringify({
                        room: room.id,
                        text,
                        password: password || '',
                    }),
                });
                messageInput.value = '';
                await fetchMessages();
            } catch (error) {
                if (error.status === 403 && room.isPrivate) {
                    clearRoomPassword(room.id);
                    activeRoomMetaEl.textContent = 'wrong password, try again';
                    showRoomGate(room, 'wrong password');
                    return;
                }
                activeRoomMetaEl.textContent = error.message || 'send failed';
            }
        }

        async function deleteActiveRoom() {
            const room = state.rooms.find((entry) => entry.id === state.activeRoomId);
            if (!canDeleteRoom(room)) return;
            const confirmed = window.confirm(`Delete #${room.name}?`);
            if (!confirmed) return;
            try {
                await apiRequest(`/api/chat/rooms/${encodeURIComponent(room.id)}`, {
                    method: 'DELETE',
                });
                activeRoomMetaEl.textContent = `#${room.name} deleted`;
                state.activeRoomId = 'lobby';
                await fetchRooms();
                await selectRoom(state.activeRoomId);
            } catch (error) {
                activeRoomMetaEl.textContent = error.message || 'delete failed';
            }
        }

        function startPolling() {
            if (state.pollTimer) clearInterval(state.pollTimer);
            state.pollTimer = setInterval(async () => {
                await fetchMessages();
            }, 3000);
        }

        roomTypeInput.addEventListener('change', () => {
            const isPrivate = roomTypeInput.value === 'private';
            roomPasswordInput.style.display = isPrivate ? '' : 'none';
            roomPasswordInput.required = isPrivate;
            if (!isPrivate) roomPasswordInput.value = '';
        });

        document.getElementById('createRoomForm').addEventListener('submit', createRoom);
        document.getElementById('messageForm').addEventListener('submit', sendMessage);
        deleteRoomBtn.addEventListener('click', deleteActiveRoom);

        (async function initChat() {
            const ok = await requireAuth();
            if (!ok) return;
            await fetchRooms();
            await selectRoom(state.activeRoomId);
            startPolling();
        })();
    </script>
</body>
</html>
